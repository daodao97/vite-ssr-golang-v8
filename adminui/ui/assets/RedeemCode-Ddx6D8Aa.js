import{t as $,u as G,o as J,n as P,G as q,P as Y,D as H,_ as K,Y as Q,w as W,V as X,a7 as Z,C as ee,a as c}from"./element-plus-Dafmimlt.js";import"./vue-B-SfU_kR.js";import{_ as te}from"./index-DrmL6QsE.js";import{r as p}from"./vue-reactivity-CXsOe-dj.js";import{c as oe,o as ae,e as h,f,v as n,k as r,l as ne,j as w,q as le,F as re,J as se,t as m,h as C}from"./vue-runtime-core-BdA0WvRm.js";import{t as E}from"./vue-shared-DfJbHraB.js";import"./lodash-es-CPGzQtoi.js";import"./vueuse-shared-ByQ8fdj-.js";import"./vueuse-core-BdHuZ0wz.js";import"./element-plus-icons-vue-D0EVbKiy.js";import"./vue-runtime-dom-CeGziGLf.js";import"./sxzz-popperjs-es-DB1lLFnh.js";import"./ctrl-tinycolor-BuyEbX8F.js";import"./dayjs-hCpwiSkR.js";import"./crypto-js-Dyp0U-M-.js";import"./async-validator-Cp9QasH9.js";import"./memoize-one-BdPwpGay.js";import"./normalize-wheel-es-BQoi3Ox2.js";import"./floating-ui-dom-BFdr95lq.js";import"./floating-ui-core-B_Ovcekz.js";import"./floating-ui-utils-dOBGhI8p.js";import"./vue-compiler-dom-CVS71qNH.js";import"./vue-compiler-core-DX1NfRgB.js";import"./vue-router-DXq6Y188.js";import"./okiss-oms-DFc_SLDJ.js";import"./okiss-utils-DLB9Z4qj.js";import"./handlebars-DuCeDWMH.js";import"./source-map-BSKk0CAR.js";import"./lodash-BU9I_SoQ.js";import"./pinia-CbWoapWl.js";import"./js-cookie-Cz0CWeBA.js";import"./mockjs-DoeQ1pEj.js";import"./axios-ngrFHoWO.js";import"./path-to-regexp-BqOC2I1t.js";import"./okiss-vbtf-C9fbskm7.js";import"./inputmask-Cg4EPAzv.js";import"./vuedraggable-Dyj1l8Pp.js";import"./sortablejs-BWyhpS7n.js";import"./file-saver-BLAVw3D0.js";import"./xlsx-BUrVjEmL.js";/* empty css                      */import"./mitt-BUWluRzQ.js";import"./vue3-markdown-it-DVMXq1Os.js";import"./nprogress-BQSorFX4.js";const ie={class:"redeem-code-tool"},de={class:"header"},ce={class:"actions"},ue={class:"mono"},me={key:1,class:"placeholder"},pe={__name:"RedeemCode",setup(fe){const u=p("default"),v=p(20),s=p([]),g=p(!1),_=p(!1),y=p(["default"]),U=oe(()=>s.value.map(t=>({code:t}))),b=t=>{const e=typeof t=="string"?t.trim():String(t??"").trim();e&&(y.value.includes(e)||(y.value=[...y.value,e].sort()))},x=async()=>{try{const t=await fetch("/_api/team/group_ids");if(!t.ok)return;const e=await t.json(),o=typeof e.code<"u"?e.data||{}:e,d=Array.isArray(o.group_ids)?o.group_ids:[],l=new Set(["default"]);u.value&&String(u.value).trim()&&l.add(String(u.value).trim()),d.forEach(a=>{typeof a=="string"&&a.trim()&&l.add(a.trim())}),y.value=Array.from(l).filter(Boolean).sort()}catch{}},S=()=>{if(typeof crypto<"u"&&crypto.randomUUID)return crypto.randomUUID();const t="ABCDEFGHJKLMNPQRSTUVWXYZ23456789",e=new Uint8Array(24);return typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues(e),Array.from(e).map(o=>t[o%t.length]).join("")},V=()=>{const t=String(u.value||"").trim()||"default",e=S();return t==="default"?e:`${t}-${e}`},I=()=>{if(g.value)return;const t=Number(v.value);if(!Number.isFinite(t)||t<=0){c.error("生成数量必须大于 0");return}const e=Math.min(Math.max(Math.floor(t),1),500);v.value=e,g.value=!0;try{const o=[],d=new Set;for(;o.length<e;){const l=V();d.has(l)||(d.add(l),o.push(l))}s.value=o,b(u.value),c.success(`已生成 ${o.length} 个兑换码`)}finally{g.value=!1}},D=async t=>{try{if(navigator.clipboard&&navigator.clipboard.writeText){await navigator.clipboard.writeText(t),c.success("复制成功");return}}catch{}const e=document.createElement("textarea");e.value=t,e.style.position="fixed",e.style.opacity="0",document.body.appendChild(e),e.focus(),e.select();try{document.execCommand("copy"),c.success("复制成功")}catch{c.error("复制失败")}finally{document.body.removeChild(e)}},N=async()=>{if(!s.value.length){c.warning("请先生成兑换码");return}if(!_.value){_.value=!0;try{const t=await fetch("/_api/team/redeem/import",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({codes:s.value})}),e=await t.text();let o;try{o=JSON.parse(e)}catch{o=null}if(!t.ok){const a=o&&typeof o=="object"?o.message:e;throw new Error(a||"提交失败")}const d=o&&typeof o.code<"u"?o.data||{}:o,l=Number(d&&d.inserted);Number.isFinite(l)&&l>=0?c.success(`成功导入 ${l} 个兑换码`):c.success("兑换码已提交")}catch(t){c.error(t.message||"提交失败")}finally{_.value=!1}}},O=()=>{if(!s.value.length){c.warning("没有可下载的兑换码");return}const t=new Blob([s.value.join(`
`)],{type:"text/plain;charset=utf-8"}),e=URL.createObjectURL(t),o=String(u.value||"default").trim()||"default",d=new Date().toISOString().replace(/[:.]/g,"-").slice(0,19),l=`redeem_${o}_${d}.txt`,a=document.createElement("a");a.href=e,a.download=l,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(e)},T=()=>{s.value=[]};return ae(()=>{b(u.value),x()}),(t,e)=>{const o=W,d=P,l=J,a=G,R=q,j=Y,B=$,A=H,k=Q,F=K,L=Z,z=ee,M=X;return f(),h("div",ie,[n(z,{shadow:"never"},{header:r(()=>[C("div",de,[e[7]||(e[7]=m(" 兑换码生成工具 ",-1)),C("div",ce,[n(o,{size:"small",onClick:I,loading:g.value},{default:r(()=>[...e[3]||(e[3]=[m(" 生成兑换码 ",-1)])]),_:1},8,["loading"]),n(o,{size:"small",type:"success",onClick:N,disabled:!s.value.length,loading:_.value},{default:r(()=>[...e[4]||(e[4]=[m(" 提交保存 ",-1)])]),_:1},8,["disabled","loading"]),n(o,{size:"small",type:"primary",onClick:O,disabled:!s.value.length},{default:r(()=>[...e[5]||(e[5]=[m(" 下载 .txt ",-1)])]),_:1},8,["disabled"]),n(o,{size:"small",onClick:T,disabled:!s.value.length},{default:r(()=>[...e[6]||(e[6]=[m(" 清空 ",-1)])]),_:1},8,["disabled"])])])]),default:r(()=>[n(B,{inline:!0,"label-width":"90px",class:"config-form"},{default:r(()=>[n(a,{label:"分组 ID"},{default:r(()=>[n(l,{modelValue:u.value,"onUpdate:modelValue":e[0]||(e[0]=i=>u.value=i),clearable:"",filterable:"","allow-create":"",placeholder:"输入或选择分组",style:{"min-width":"200px"},onChange:b,onVisibleChange:e[1]||(e[1]=i=>i&&x())},{default:r(()=>[(f(!0),h(re,null,se(y.value,i=>(f(),w(d,{key:i,label:i,value:i},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),n(a,{label:"生成数量"},{default:r(()=>[n(R,{modelValue:v.value,"onUpdate:modelValue":e[2]||(e[2]=i=>v.value=i),min:1,max:500},null,8,["modelValue"])]),_:1}),s.value.length?(f(),w(a,{key:0,label:"预览数量"},{default:r(()=>[n(j,{type:"info"},{default:r(()=>[m(E(s.value.length),1)]),_:1})]),_:1})):le("",!0)]),_:1}),n(A,{type:"info","show-icon":"",class:"mb12",title:"规则说明",description:"格式为 {group_id}-{UUID}；当分组为 default 或留空时，仅使用 UUID。"}),s.value.length?ne((f(),w(F,{key:0,data:U.value,size:"small",border:!0},{default:r(()=>[n(k,{type:"index",width:"60",label:"#"}),n(k,{prop:"code",label:"兑换码"},{default:r(({row:i})=>[C("span",ue,E(i.code),1),n(o,{type:"primary",link:"",size:"small",onClick:()=>D(i.code)},{default:r(()=>[...e[8]||(e[8]=[m(" 复制 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[M,_.value]]):(f(),h("div",me,[n(L,{description:"请先选择分组与数量，点击生成兑换码"})]))]),_:1})])}}},lt=te(pe,[["__scopeId","data-v-994aa6e9"]]);export{lt as default};
